# Evidence Binding Result Schema
# STEP V2-5: Evidence-to-Compare Binding
#
# Evidence 슬롯 → Compare 결과 필드 바인딩 규약

schema:
  name: binding_result
  version: "1.0.0"
  description: "V2-5 Evidence Binding 출력 규약"

# Compare 결과 상태 (5가지)
compare_decision:
  determined:
    description: "결과 확정"
    meaning: "금액 및 조건이 명확하게 결정됨"

  no_amount:
    description: "금액 근거 부재"
    meaning: "PASS 1에서 금액 증거를 찾지 못함"

  condition_mismatch:
    description: "조건 충돌"
    meaning: "금액은 있으나 조건 간 충돌 감지"

  definition_only:
    description: "정의만 존재"
    meaning: "정의 증거만 있고 금액 증거 없음"

  insufficient_evidence:
    description: "판단 불가"
    meaning: "판단 가능한 증거 없음"

# 결정 규칙
decision_rules:
  # Amount Binding Rules
  amount_primary:
    description: "Amount 최우선 규칙"
    applies_when: "amount evidence >= 1"

  doc_priority:
    description: "문서 우선순위"
    order: "약관 > 사업방법서"

  condition_explicit:
    description: "지급 조건 명시 우선"
    applies_when: "조건이 명시된 증거 우선"

  page_asc:
    description: "페이지 시작 위치 오름차순"
    tie_breaker: true

  # Condition Binding Rules
  condition_same_doc:
    description: "Amount와 동일 문서 우선"
    applies_when: "condition과 amount가 같은 문서"

  condition_conflict:
    description: "조건 충돌 감지"
    applies_when: "조건 간 충돌 발견"

  # Definition Binding Rules
  definition_only:
    description: "정의만 존재"
    applies_when: "amount 없이 definition만 있음"

  definition_no_amount:
    description: "정의 있으나 금액 없음"
    applies_when: "definition은 있지만 amount 없음"

  # Failure Rules
  no_evidence:
    description: "증거 없음"
    applies_when: "모든 슬롯 비어있음"

  pass_1_empty:
    description: "PASS 1 결과 없음"
    applies_when: "EvidenceRetriever가 NoAmountFoundResult 반환"

# Binding 규칙 순서
binding_priority:
  1_amount:
    description: "Amount Binding (최우선)"
    steps:
      - "amount evidence >= 1 확인"
      - "PASS 1에서 나온 evidence만 사용"
      - "tie-breaker 적용"

  2_condition:
    description: "Condition Binding"
    prerequisite: "amount 확정"
    steps:
      - "amount_evidence와 동일 문서 우선"
      - "조건 충돌 감지"

  3_definition:
    description: "Definition Binding"
    constraint: "금액 변경 불가"
    steps:
      - "정보 보완 목적으로만 사용"

# Explanation 구조 (필수)
explanation:
  type: object
  required: true
  properties:
    decision:
      type: string
      enum: ["determined", "no_amount", "condition_mismatch", "definition_only", "insufficient_evidence"]
    applied_rules:
      type: array
      items:
        type: string
    used_evidence_ids:
      type: array
      items:
        type: string
    dropped_evidence:
      type: array
      items:
        type: string
    reason:
      type: array
      items:
        type: string
      constraints:
        - "사실 기반만 허용"
        - "자연어 요약 금지"
        - "'~로 보입니다' 금지"
        - "해석/추론 문장 금지"

# Binding Result 구조
binding_result:
  type: object
  properties:
    decision:
      type: string
      required: true
    explanation:
      $ref: "#/explanation"
      required: true
    bound_evidence:
      type: array
      items:
        type: object
        properties:
          evidence_id:
            type: string
          slot_type:
            type: string
            enum: ["amount", "condition", "definition"]
          doc_type:
            type: string
          doc_id:
            type: string
          page:
            type: integer
          excerpt:
            type: string
          binding_rule:
            type: string
    amount_value:
      type: string
      description: "확정된 금액 (문자열)"
    amount_numeric:
      type: integer
      description: "확정된 금액 (숫자)"

# Partial Failure 규칙 (ADR-003)
partial_failure:
  decisions:
    - no_amount
    - condition_mismatch
    - definition_only
    - insufficient_evidence
  constraints:
    - "추정 금지"
    - "보완 추론 금지"
    - "silent fallback 금지"

# 예시 출력
examples:
  determined:
    decision: "determined"
    explanation:
      decision: "determined"
      applied_rules:
        - "amount_primary"
        - "doc_priority"
      used_evidence_ids:
        - "EVID-001"
        - "EVID-002"
      dropped_evidence: []
      reason:
        - "금액 증거: 약관에서 발견"
        - "금액 확정: 5천만원"
    bound_evidence:
      - evidence_id: "EVID-001"
        slot_type: "amount"
        doc_type: "약관"
        doc_id: "SAMSUNG_CANCER_2024"
        page: 45
        excerpt: "암 진단 확정시 5천만원 지급"
        binding_rule: "amount_primary"
    amount_value: "5천만원"
    amount_numeric: 50000000

  no_amount:
    decision: "no_amount"
    explanation:
      decision: "no_amount"
      applied_rules:
        - "pass_1_empty"
      used_evidence_ids: []
      dropped_evidence: []
      reason:
        - "PASS 1 결과 없음: no_amount_bearing_evidence"

  condition_mismatch:
    decision: "condition_mismatch"
    explanation:
      decision: "condition_mismatch"
      applied_rules:
        - "amount_primary"
        - "condition_conflict"
      used_evidence_ids:
        - "EVID-001"
      dropped_evidence: []
      reason:
        - "금액 증거: 약관에서 발견"
        - "조건 충돌 감지됨 - 금액은 유지"
    bound_evidence:
      - evidence_id: "EVID-001"
        slot_type: "amount"
        doc_type: "약관"
        doc_id: "SAMSUNG_CANCER_2024"
        page: 45
    amount_value: "3천만원"
    amount_numeric: 30000000

# 불변 규칙
invariants:
  - name: "explanation 필수"
    rule: "모든 BindingResult에 explanation 존재"

  - name: "규칙 기반 결정"
    rule: "Compare 결과는 규칙의 결과"

  - name: "LLM 금지"
    rule: "LLM 호출 금지"

  - name: "embedding 금지"
    rule: "embedding score 사용 금지"

  - name: "추론 금지"
    rule: "'가장 그럴듯한' 선택 금지"

  - name: "silent fallback 금지"
    rule: "조용한 대체 금지"
