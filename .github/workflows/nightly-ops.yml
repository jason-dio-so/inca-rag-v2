name: Nightly Ops Monitoring

on:
  schedule:
    # Run at 00:00 UTC every day
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual trigger
  push:
    branches: [main]
    paths:
      - 'tools/collect_metrics.py'
      - 'tools/detect_golden_drift.py'
      - 'tools/render_ops_report.py'
      - 'eval/golden_set_v2_7.json'

permissions:
  contents: read
  pull-requests: write

jobs:
  ops-monitoring:
    name: Operations Monitoring
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pyyaml

      - name: Run Tests
        id: tests
        run: |
          pytest -q 2>&1 | tee pytest.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Collect Metrics
        id: metrics
        continue-on-error: true
        run: |
          python tools/collect_metrics.py 2>&1 | tee metrics.log
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Detect Golden Drift
        id: drift
        continue-on-error: true
        run: |
          python tools/detect_golden_drift.py 2>&1 | tee drift.log
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Render Ops Report
        id: report
        run: |
          python tools/render_ops_report.py 2>&1 | tee report.log

      - name: Upload Metrics and Dashboard Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ops-dashboard-${{ github.run_number }}
          path: |
            metrics/*.json
            docs/ops/OPS-REPORT-*.md
            dashboard/index.html
            dashboard/dashboard.js
            dashboard/README.md

      - name: Check for Warnings/Errors
        id: check_status
        run: |
          # Read ops summary
          STATUS=$(python3 -c "
          import json
          with open('metrics/ops_summary.json', 'r') as f:
              data = json.load(f)
              print(data.get('level', 'INFO'))
          ")
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          if [ "$STATUS" = "ERROR" ]; then
            echo "::error::Ops monitoring detected ERROR level issues"
            exit 1
          elif [ "$STATUS" = "WARNING" ]; then
            echo "::warning::Ops monitoring detected WARNING level issues"
          fi

      - name: Summary
        run: |
          echo "## Ops Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add status
          STATUS="${{ steps.check_status.outputs.status }}"
          if [ "$STATUS" = "ERROR" ]; then
            echo "**Status:** ❌ ERROR" >> $GITHUB_STEP_SUMMARY
          elif [ "$STATUS" = "WARNING" ]; then
            echo "**Status:** ⚠️ WARNING" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ✅ HEALTHY" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Metrics Collected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Decision Distribution: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Partial Failure Rate: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Evidence Quality: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Source Boundary: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Golden Drift: ✅" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ops Report & Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the \`ops-dashboard-*\` artifact to view:" >> $GITHUB_STEP_SUMMARY
          echo "- **Dashboard**: Open \`dashboard/index.html\` in browser" >> $GITHUB_STEP_SUMMARY
          echo "- **Report**: See \`docs/ops/OPS-REPORT-*.md\`" >> $GITHUB_STEP_SUMMARY
